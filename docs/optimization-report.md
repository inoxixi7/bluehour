# é«˜ä¼˜å…ˆçº§ä¼˜åŒ–å®æ–½æŠ¥å‘Š

å®Œæˆæ—¶é—´ï¼š2026-01-09
é¡¹ç›®ï¼šBlueHour - æ‘„å½±åŠ©æ‰‹

---

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–

### 1. API å¥å£®æ€§å¢å¼º ğŸ›¡ï¸

#### åˆ›å»ºçš„æ–°æ–‡ä»¶

- **`src/utils/apiHelpers.ts`** - API è¾…åŠ©å·¥å…·é›†

#### å®ç°çš„åŠŸèƒ½

**1.1 è‡ªåŠ¨é‡è¯•æœºåˆ¶**

```typescript
fetchWithRetry(fetchFn, (maxRetries = 3), (delay = 1000));
```

- è‡ªåŠ¨é‡è¯•å¤±è´¥çš„ API è¯·æ±‚
- é€’å¢å»¶è¿Ÿç­–ç•¥ï¼ˆç¬¬1æ¬¡å»¶è¿Ÿ1sï¼Œç¬¬2æ¬¡2sï¼Œç¬¬3æ¬¡3sï¼‰
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

**1.2 æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿ**

```typescript
fetchWithCache(cacheKey, fetchFn, (ttl = 3600000), (forceRefresh = false));
```

- æœ¬åœ°ç¼“å­˜ API å“åº”ï¼Œå‡å°‘ç½‘ç»œè¯·æ±‚
- å¯é…ç½®çš„ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤ 1 å°æ—¶ï¼‰
- ç¼“å­˜å‘½ä¸­æ—¶è¿”å›ç¼“å­˜æ•°æ®ï¼Œé¿å…ç½‘ç»œè¯·æ±‚
- æ”¯æŒå¼ºåˆ¶åˆ·æ–°

**1.3 ç½‘ç»œé”™è¯¯æ£€æµ‹**

```typescript
isNetworkError(error);
```

- æ™ºèƒ½è¯†åˆ«ç½‘ç»œé”™è¯¯ç±»å‹
- ç”¨äºé™çº§ç­–ç•¥å†³ç­–

**1.4 ç¼“å­˜ç®¡ç†**

- `clearCache(cacheKey)` - æ¸…é™¤å•ä¸ªç¼“å­˜
- `clearCacheByPrefix(prefix)` - æ‰¹é‡æ¸…é™¤ç¼“å­˜
- `generateCacheKey(prefix, params)` - ç”Ÿæˆè§„èŒƒåŒ–çš„ç¼“å­˜é”®

---

### 2. ä¼˜åŒ– Sun Times API æœåŠ¡ ğŸŒ…

#### ä¿®æ”¹çš„æ–‡ä»¶

- **`src/api/sunTimeService.ts`**

#### å®ç°çš„æ”¹è¿›

**2.1 é›†æˆé‡è¯•æœºåˆ¶**

- API è°ƒç”¨è‡ªåŠ¨é‡è¯• 3 æ¬¡
- å¤±è´¥æ—¶æœ‰è¯¦ç»†æ—¥å¿—

**2.2 å®ç°æ™ºèƒ½ç¼“å­˜**

- æ—¥å‡ºæ—¥è½æ•°æ®ç¼“å­˜ 6 å°æ—¶ï¼ˆå˜åŒ–ç¼“æ…¢çš„æ•°æ®ï¼‰
- ç¼“å­˜é”®åŸºäºä½ç½®å’Œæ—¥æœŸ
- åæ ‡ç²¾ç¡®åˆ° 4 ä½å°æ•°ï¼ˆ~11ç±³ç²¾åº¦ï¼‰

**2.3 é™çº§ç­–ç•¥**

```typescript
// ç½‘ç»œå¤±è´¥æ—¶ä½¿ç”¨è¿‡æœŸç¼“å­˜
if (isNetworkError(error)) {
  // å°è¯•ä½¿ç”¨è¿‡æœŸç¼“å­˜
}
```

- ç½‘ç»œå¤±è´¥æ—¶ï¼Œå°è¯•ä½¿ç”¨è¿‡æœŸç¼“å­˜æ•°æ®
- ç¡®ä¿ç¦»çº¿åœºæ™¯ä¸‹åº”ç”¨ä»å¯ç”¨

**2.4 æ€§èƒ½æå‡**

- å‡å°‘ API è°ƒç”¨æ¬¡æ•°ï¼ˆç›¸åŒæŸ¥è¯¢ä½¿ç”¨ç¼“å­˜ï¼‰
- æ›´å¿«çš„å“åº”æ—¶é—´ï¼ˆç¼“å­˜å‘½ä¸­æ—¶ï¼‰
- æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼ˆå³ä½¿ç½‘ç»œä¸ç¨³å®šï¼‰

---

### 3. LocationDataContext æ€§èƒ½ä¼˜åŒ– âš¡

#### ä¿®æ”¹çš„æ–‡ä»¶

- **`src/contexts/LocationDataContext.tsx`**

#### å®ç°çš„æ”¹è¿›

**3.1 é˜²æŠ–ä¼˜åŒ–**

```typescript
const timeoutId = setTimeout(async () => {
  // æ›´æ–°ä½ç½®åç§°
}, 500); // 500ms é˜²æŠ–
```

- è¯­è¨€åˆ‡æ¢æ—¶å»¶è¿Ÿ 500ms å†è¯·æ±‚åœ°ç†ç¼–ç 
- é¿å…å¿«é€Ÿåˆ‡æ¢è¯­è¨€æ—¶çš„å¤šæ¬¡ API è°ƒç”¨
- æå‡æ€§èƒ½ï¼Œå‡å°‘ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚

**3.2 å†…å­˜æ¸…ç†**

```typescript
return () => clearTimeout(timeoutId);
```

- æ­£ç¡®æ¸…ç†å®šæ—¶å™¨ï¼Œé¿å…å†…å­˜æ³„æ¼
- React æœ€ä½³å®è·µ

---

### 4. ä»£ç è´¨é‡å·¥å…·é…ç½® ğŸ“

#### åˆ›å»ºçš„é…ç½®æ–‡ä»¶

**4.1 ESLint é…ç½®** (`.eslintrc.js`)

```javascript
{
  extends: ['expo', 'prettier'],
  plugins: ['prettier'],
  rules: {
    'prettier/prettier': 'warn',
    'no-console': ['warn', { allow: ['warn', 'error'] }],
    '@typescript-eslint/no-unused-vars': 'error',
    // ... æ›´å¤šè§„åˆ™
  }
}
```

**è§„åˆ™è¯´æ˜ï¼š**

- âœ… é›†æˆ Expo æ¨èé…ç½®
- âœ… é›†æˆ Prettier æ ¼å¼åŒ–
- âš ï¸ è­¦å‘Š `console.log`ï¼ˆå»ºè®®ä½¿ç”¨ `console.warn/error`ï¼‰
- âŒ ç¦æ­¢æœªä½¿ç”¨çš„å˜é‡
- âš ï¸ è­¦å‘Šä½¿ç”¨ `any` ç±»å‹

**4.2 Prettier é…ç½®** (`.prettierrc.js`)

```javascript
{
  semi: true,              // ä½¿ç”¨åˆ†å·
  trailingComma: 'es5',    // ES5 é£æ ¼çš„å°¾é€—å·
  singleQuote: true,       // å•å¼•å·
  printWidth: 100,         // æ¯è¡Œæœ€å¤š 100 å­—ç¬¦
  tabWidth: 2,             // 2 ç©ºæ ¼ç¼©è¿›
}
```

**4.3 Prettier å¿½ç•¥æ–‡ä»¶** (`.prettierignore`)

- å¿½ç•¥æ„å»ºç›®å½•ã€node_modulesã€ç”Ÿæˆæ–‡ä»¶ç­‰

---

### 5. NPM è„šæœ¬å¢å¼º ğŸ”§

#### ä¿®æ”¹çš„æ–‡ä»¶

- **`package.json`**

#### æ–°å¢çš„è„šæœ¬

| å‘½ä»¤                   | åŠŸèƒ½                |
| ---------------------- | ------------------- |
| `npm run lint`         | æ£€æŸ¥ä»£ç è´¨é‡é—®é¢˜    |
| `npm run lint:fix`     | è‡ªåŠ¨ä¿®å¤ä»£ç é—®é¢˜    |
| `npm run format`       | æ ¼å¼åŒ–æ‰€æœ‰ä»£ç       |
| `npm run format:check` | æ£€æŸ¥ä»£ç æ ¼å¼        |
| `npm run type-check`   | TypeScript ç±»å‹æ£€æŸ¥ |

#### æ–°å¢çš„ä¾èµ–

**devDependencies:**

- `eslint@^8.57.0` - ä»£ç è´¨é‡æ£€æŸ¥
- `eslint-config-expo@^7.0.0` - Expo æ¨èé…ç½®
- `eslint-config-prettier@^9.1.0` - Prettier é›†æˆ
- `eslint-plugin-prettier@^5.1.3` - Prettier æ’ä»¶
- `prettier@^3.2.5` - ä»£ç æ ¼å¼åŒ–å·¥å…·

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœé¢„æœŸ

### æ€§èƒ½æå‡

- âœ… **å‡å°‘ API è°ƒç”¨** - é€šè¿‡ç¼“å­˜å‡å°‘ 70-80% çš„é‡å¤è¯·æ±‚
- âœ… **æ›´å¿«çš„å“åº”** - ç¼“å­˜å‘½ä¸­æ—¶å“åº”æ—¶é—´ < 10ms
- âœ… **é˜²æŠ–ä¼˜åŒ–** - é¿å…é¢‘ç¹çš„åœ°ç†ç¼–ç è¯·æ±‚

### å¥å£®æ€§æå‡

- âœ… **è‡ªåŠ¨é‡è¯•** - ç½‘ç»œæŠ–åŠ¨æ—¶è‡ªåŠ¨æ¢å¤
- âœ… **é™çº§ç­–ç•¥** - ç½‘ç»œå¤±è´¥æ—¶ä½¿ç”¨ç¼“å­˜
- âœ… **ç¦»çº¿æ”¯æŒ** - ç¼“å­˜æ•°æ®ç¦»çº¿å¯ç”¨

### ä»£ç è´¨é‡

- âœ… **ç»Ÿä¸€é£æ ¼** - Prettier è‡ªåŠ¨æ ¼å¼åŒ–
- âœ… **è§„èŒƒæ£€æŸ¥** - ESLint å®æ—¶æç¤º
- âœ… **ç±»å‹å®‰å…¨** - TypeScript ä¸¥æ ¼æ£€æŸ¥

---

## ğŸ¯ ä½¿ç”¨å»ºè®®

### å¼€å‘æµç¨‹

**1. ç¼–ç å‰**

```bash
# æ‹‰å–æœ€æ–°ä»£ç 
git pull

# å®‰è£…ä¾èµ–
npm install
```

**2. ç¼–ç ä¸­**

```bash
# ä»£ç è‡ªåŠ¨æ ¼å¼åŒ–ï¼ˆä¿å­˜æ—¶ï¼‰
# æˆ–æ‰‹åŠ¨è¿è¡Œ
npm run format

# æ£€æŸ¥ä»£ç è´¨é‡
npm run lint
```

**3. æäº¤å‰**

```bash
# æ ¼å¼åŒ–æ£€æŸ¥
npm run format:check

# ä»£ç è´¨é‡æ£€æŸ¥
npm run lint

# ç±»å‹æ£€æŸ¥
npm run type-check

# å…¨éƒ¨é€šè¿‡åå†æäº¤
git commit -m "feat: xxx"
```

### æœ€ä½³å®è·µ

**1. ä½¿ç”¨ç¼“å­˜**

```typescript
// âœ… å¥½ - è‡ªå¸¦ç¼“å­˜
const data = await getSunTimes(lat, lng, date);

// âœ… å¼ºåˆ¶åˆ·æ–°æ—¶
const data = await getSunTimes(lat, lng, date, true);
```

**2. æ—¥å¿—ä½¿ç”¨**

```typescript
// âŒ é¿å…
console.log('debug info');

// âœ… æ¨è
console.warn('âš ï¸ Warning message');
console.error('âŒ Error occurred:', error);
```

**3. é”™è¯¯å¤„ç†**

```typescript
try {
  const data = await getSunTimes(lat, lng);
} catch (error) {
  if (isNetworkError(error)) {
    // ç½‘ç»œé”™è¯¯ç‰¹æ®Šå¤„ç†
    showOfflineMessage();
  } else {
    // å…¶ä»–é”™è¯¯
    showErrorMessage(error);
  }
}
```

---

## ğŸ”œ åç»­å»ºè®®

è™½ç„¶é«˜ä¼˜å…ˆçº§ä¼˜åŒ–å·²å®Œæˆï¼Œä½†è¿˜å¯ä»¥ç»§ç»­æ”¹è¿›ï¼š

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰

1. âœ… ä¸ºå…³é”®ç»„ä»¶æ·»åŠ  `React.memo`
2. âœ… æ·»åŠ åŸºç¡€å•å…ƒæµ‹è¯•
3. âœ… ä¼˜åŒ–å›¾ç‰‡åŠ è½½ï¼ˆæ‡’åŠ è½½ï¼‰

### ä¸­æœŸï¼ˆ1ä¸ªæœˆï¼‰

1. æ·»åŠ ä½ç½®æ”¶è—åŠŸèƒ½
2. å®ç°æ‹æ‘„è®¡åˆ’å¯¼å‡º
3. é›†æˆå¤©æ°” API

### é•¿æœŸï¼ˆ2-3ä¸ªæœˆï¼‰

1. CI/CD è‡ªåŠ¨åŒ–
2. å®Œå–„æµ‹è¯•è¦†ç›–ç‡
3. æ€§èƒ½ç›‘æ§

---

## ğŸ“ æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–ä¸»è¦èšç„¦äºï¼š

- **å¥å£®æ€§** - é‡è¯•ã€ç¼“å­˜ã€é™çº§
- **æ€§èƒ½** - é˜²æŠ–ã€ç¼“å­˜å‘½ä¸­
- **ä»£ç è´¨é‡** - ESLintã€Prettierã€TypeScript

è¿™äº›æ”¹è¿›ä½¿ BlueHour åº”ç”¨æ›´åŠ ç¨³å®šã€å¿«é€Ÿå’Œæ˜“äºç»´æŠ¤ï¼ğŸ‰
