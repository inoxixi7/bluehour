import * as Localization from 'expo-localization';
import { useEffect, useState } from 'react';
import AsyncStorage from '@react-native-async-storage/async-storage';

export type AppLocale = 'zh' | 'en' | 'ja' | 'de';

// 语言资源
const resources: Record<AppLocale, Record<string, string>> = {
  zh: {
    appName: 'BlueHour',
    loadingLocation: '获取位置信息中...',
    loadingSun: '计算摄影时间中...',
    retry: '重试',
    errorLocationTitle: '无法获取位置信息',
    errorLocationMessage: '无法获取您的位置信息，请检查定位权限。',
    errorSunTitle: '无法获取太阳时间',
    close: '关闭',
    settings: '设置',
    search: '搜索',
    todayTimeline: '今日时刻表',
    current: '当前',
    nextPhase: '下一阶段',
    firstLight: '第一道光',
    morningBlue: '蓝色时刻（早）',
    dawnInterval: '曙光',
    morningGolden: '黄金时刻（早）',
    dayInterval: '白天',
    eveningGolden: '黄金时刻（晚）',
    duskInterval: '暮光',
    eveningBlue: '蓝色时刻（晚）',
    lastLight: '最后的光',
    sunrise: '日出',
    solarNoon: '正午',
    sunset: '日落',
    tipsExpand: '展开更多',
    tipsCollapse: '收起',
    cancel: '取消',
    phase_night: '夜间',
    phase_first_light: '第一道光',
    phase_dawn: '曙光',
    phase_sunrise: '日出',
    phase_day: '白天',
    phase_golden_hour: '黄金时刻',
    phase_sunset: '日落',
    phase_blue_hour: '蓝调时刻',
    language: '语言',
    lang_zh: '中文',
    lang_en: '英文',
    lang_ja: '日文',
    lang_de: '德文',
    period_night_name: '夜间',
    period_night_desc: '低光环境，适合星空与长曝光创作',
    period_first_light_name: '第一道光',
    period_first_light_desc: '天空渐亮形成剪影，对比柔和需提前布点',
    period_dawn_name: '曙光',
    period_dawn_desc: '光线渐强层次丰富，适合风景、人像预热',
    period_sunrise_name: '日出',
    period_sunrise_desc: '色温快速变化，抓住黄金几分钟',
    period_day_name: '白天',
    period_day_desc: '光比大，注意控制曝光与阴影利用',
    period_golden_hour_name: '黄金时刻',
    period_golden_hour_desc: '暖色斜射光塑造质感与层次',
    period_sunset_name: '日落',
    period_sunset_desc: '色彩递进变化，留意余晖与云结构',
    period_blue_hour_name: '蓝调时刻',
    period_blue_hour_desc: '冷暖对比明显，城市灯光与天空最佳融合',
    appInfoTitle: '应用信息',
    appSlogan: '为追光而生',
    appIntro: 'BlueHour 是为每一位摄影师和追光者设计的专属工具。它能根据您选择的全球任意地点和日期，精准推算出稍纵即逝的黄金时刻与蓝调时刻，让您不再错过任何绝佳光线。',
    coreFeatures: '核心功能',
    feature_preciseAstronomy: '• 精准天文数据：提供日出、日落、民用/航海曙暮光等关键时间点。',
    feature_dynamicPeriods: '• 动态时段推算：基于算法计算不同季节和纬度下黄金与蓝调时刻的真实时长。',
    feature_globalSearch: '• 全球地点搜索：快速搜索并保存历史，便于出行规划。',
    feature_liveTracking: '• 实时光线追踪：进度条高亮当前光线阶段。',
    feature_timezone: '• 智能时区支持：自动显示所选地点当地时间。',
    feedbackWelcome: '您的建议很重要',
    feedbackDesc: '我们致力于打造最好的光线预测工具。如有问题或功能想法，欢迎反馈。',
    dataCredits: '数据来源与致谢',
    dataCreditsDesc: '本应用核心功能离不开以下优秀服务的支持，谨致感谢：',
    credit_sunrise_sunset: '• 天文数据由 Sunrise-Sunset.org 提供',
    credit_nominatim: '• 地理位置查询由 Nominatim (OpenStreetMap) 提供',
    versionLabel: '版本',
    searchCityTitle: '搜索城市 / 地点',
    searchPlaceholder: '输入城市名称 (如 Beijing, Tokyo, Paris)',
    recentSelections: '最近选择',
    clear: '清空',
    noResults: '暂无结果',
    searchFailed: '搜索失败',
  },
  en: {
    appName: 'BlueHour',
    loadingLocation: 'Fetching location...',
    loadingSun: 'Calculating light periods...',
    retry: 'Retry',
    errorLocationTitle: 'Unable to get location',
    errorLocationMessage: 'Cannot access your location. Please check permission settings.',
    errorSunTitle: 'Unable to get sun data',
    close: 'Close',
    settings: 'Settings',
    search: 'Search',
    todayTimeline: "Today's Timeline",
    current: 'Current',
    nextPhase: 'Next',
    firstLight: 'First Light',
    morningBlue: 'Blue Hour (AM)',
    dawnInterval: 'Civil Dawn',
    morningGolden: 'Golden Hour (AM)',
    dayInterval: 'Daylight',
    eveningGolden: 'Golden Hour (PM)',
    duskInterval: 'Civil Dusk',
    eveningBlue: 'Blue Hour (PM)',
    lastLight: 'Last Light',
    sunrise: 'Sunrise',
    solarNoon: 'Solar Noon',
    sunset: 'Sunset',
    tipsExpand: 'More',
    tipsCollapse: 'Less',
    cancel: 'Cancel',
    phase_night: 'Night',
    phase_first_light: 'First Light',
    phase_dawn: 'Civil Dawn',
    phase_sunrise: 'Sunrise',
    phase_day: 'Daytime',
    phase_golden_hour: 'Golden Hour',
    phase_sunset: 'Sunset',
    phase_blue_hour: 'Blue Hour',
    language: 'Language',
    lang_zh: 'Chinese',
    lang_en: 'English',
    lang_ja: 'Japanese',
    lang_de: 'German',
    period_night_name: 'Night',
    period_night_desc: 'Low light ideal for stars and long exposure work',
    period_first_light_name: 'First Light',
    period_first_light_desc: 'Emerging silhouettes, soft contrast – arrive early',
    period_dawn_name: 'Civil Dawn',
    period_dawn_desc: 'Rapid tonal build-up, great for landscape warm‑up',
    period_sunrise_name: 'Sunrise',
    period_sunrise_desc: 'Color temperature shifts fast – shoot continuously',
    period_day_name: 'Daytime',
    period_day_desc: 'High contrast – manage highlights & use shadows',
    period_golden_hour_name: 'Golden Hour',
    period_golden_hour_desc: 'Warm directional light adds depth & texture',
    period_sunset_name: 'Sunset',
    period_sunset_desc: 'Layered gradients & afterglow – watch the clouds',
    period_blue_hour_name: 'Blue Hour',
    period_blue_hour_desc: 'Cool / warm balance – city lights blend perfectly',
    appInfoTitle: 'App Info',
    appSlogan: 'Made for Chasing Light',
    appIntro: 'BlueHour is a tool for photographers and light chasers. It calculates fleeting golden & blue hour windows for any location and date so you never miss great light.',
    coreFeatures: 'Core Features',
    feature_preciseAstronomy: '• Accurate solar & twilight data (sunrise, sunset, civil etc.)',
    feature_dynamicPeriods: '• Dynamic period lengths by season & latitude',
    feature_globalSearch: '• Global location search with quick history',
    feature_liveTracking: '• Live phase tracking with highlighted progress',
    feature_timezone: '• Smart timezone handling for selected place',
    feedbackWelcome: 'Your Feedback Matters',
    feedbackDesc: 'We aim to build the best light planning tool. Send ideas or issues any time.',
    dataCredits: 'Data & Credits',
    dataCreditsDesc: 'This app depends on these great services – thank you:',
    credit_sunrise_sunset: '• Solar data by Sunrise-Sunset.org',
    credit_nominatim: '• Geocoding by Nominatim (OpenStreetMap)',
    versionLabel: 'Version',
    searchCityTitle: 'Search City / Place',
    searchPlaceholder: 'Type a city name (e.g. Beijing, Tokyo, Paris)',
    recentSelections: 'Recent Selections',
    clear: 'Clear',
    noResults: 'No results',
    searchFailed: 'Search failed',
  },
  ja: {
    appName: 'BlueHour',
    loadingLocation: '位置情報を取得中...',
    loadingSun: '光の時間帯を計算中...',
    retry: '再試行',
    errorLocationTitle: '位置情報を取得できません',
    errorLocationMessage: '位置情報にアクセスできません。権限設定を確認してください。',
    errorSunTitle: '太陽データを取得できません',
    close: '閉じる',
    settings: '設定',
    search: '検索',
    todayTimeline: '今日のタイムライン',
    current: '現在',
    nextPhase: '次',
    firstLight: 'ファーストライト',
    morningBlue: 'ブルーアワー（朝）',
    dawnInterval: '市民薄明（朝）',
    morningGolden: 'ゴールデンアワー（朝）',
    dayInterval: '日中',
    eveningGolden: 'ゴールデンアワー（夕）',
    duskInterval: '市民薄明（夕）',
    eveningBlue: 'ブルーアワー（夕）',
    lastLight: 'ラストライト',
    sunrise: '日の出',
    solarNoon: '正午',
    sunset: '日の入',
    tipsExpand: 'もっと見る',
    tipsCollapse: '閉じる',
    cancel: 'キャンセル',
    phase_night: '夜間',
    phase_first_light: 'ファーストライト',
    phase_dawn: '市民薄明（朝）',
    phase_sunrise: '日の出',
    phase_day: '日中',
    phase_golden_hour: 'ゴールデンアワー',
    phase_sunset: '日の入',
    phase_blue_hour: 'ブルーアワー',
    language: '言語',
    lang_zh: '中国語',
    lang_en: '英語',
    lang_ja: '日本語',
    lang_de: 'ドイツ語',
    period_night_name: '夜間',
    period_night_desc: '低照度で星景や長時間露光に最適',
    period_first_light_name: 'ファーストライト',
    period_first_light_desc: 'シルエットと柔らかなコントラスト 早めの準備',
    period_dawn_name: '市民薄明（朝）',
    period_dawn_desc: '階調が増える時間 布石ショットに最適',
    period_sunrise_name: '日の出',
    period_sunrise_desc: '色温度が急変 継続的にシャッターを切る',
    period_day_name: '日中',
    period_day_desc: 'コントラスト大 高光部管理と影の活用',
    period_golden_hour_name: 'ゴールデンアワー',
    period_golden_hour_desc: '暖色の斜光が質感と奥行きを演出',
    period_sunset_name: '日の入',
    period_sunset_desc: 'グラデーションと残照 雲の形に注目',
    period_blue_hour_name: 'ブルーアワー',
    period_blue_hour_desc: '冷暖対比 都市光と空の調和が最良',
    appInfoTitle: 'アプリ情報',
    appSlogan: '光を追うために',
    appIntro: 'BlueHour は光を追い求める写真家のためのツールです。任意の場所と日付でゴールデン / ブルーアワーを素早く算出します。',
    coreFeatures: '主な機能',
    feature_preciseAstronomy: '• 精密な太陽/薄明データ',
    feature_dynamicPeriods: '• 緯度と季節に応じた動的長さ',
    feature_globalSearch: '• グローバル検索と履歴',
    feature_liveTracking: '• 現在フェーズを進捗表示',
    feature_timezone: '• 選択地点のタイムゾーン処理',
    feedbackWelcome: 'フィードバック歓迎',
    feedbackDesc: '最良の光計画ツールを目指しています。ご意見をぜひ。',
    dataCredits: 'データ/クレジット',
    dataCreditsDesc: '次のサービスに支えられています:',
    credit_sunrise_sunset: '• 太陽データ: Sunrise-Sunset.org',
    credit_nominatim: '• ジオコーディング: Nominatim (OpenStreetMap)',
    versionLabel: 'バージョン',
    searchCityTitle: '都市 / 地点を検索',
    searchPlaceholder: '都市名を入力 (例 Beijing, Tokyo, Paris)',
    recentSelections: '最近の選択',
    clear: 'クリア',
    noResults: '結果なし',
    searchFailed: '検索失敗',
  },
  de: {
    appName: 'BlueHour',
    loadingLocation: 'Standort wird ermittelt...',
    loadingSun: 'Lichtphasen werden berechnet...',
    retry: 'Erneut',
    errorLocationTitle: 'Standort konnte nicht ermittelt werden',
    errorLocationMessage: 'Standort kann nicht abgerufen werden. Bitte Berechtigungen prüfen.',
    errorSunTitle: 'Sonnendaten konnten nicht geladen werden',
    close: 'Schließen',
    settings: 'Einstellungen',
    search: 'Suche',
    todayTimeline: 'Heutiger Zeitplan',
    current: 'Aktuell',
    nextPhase: 'Nächste',
    firstLight: 'Erstes Licht',
    morningBlue: 'Blaue Stunde (Morgens)',
    dawnInterval: 'Bürgerliche Morgendämmerung',
    morningGolden: 'Goldene Stunde (Morgens)',
    dayInterval: 'Tageslicht',
    eveningGolden: 'Goldene Stunde (Abends)',
    duskInterval: 'Bürgerliche Abenddämmerung',
    eveningBlue: 'Blaue Stunde (Abends)',
    lastLight: 'Letztes Licht',
    sunrise: 'Sonnenaufgang',
    solarNoon: 'Sonnenhöchststand',
    sunset: 'Sonnenuntergang',
    tipsExpand: 'Mehr',
    tipsCollapse: 'Weniger',
    cancel: 'Abbrechen',
    phase_night: 'Nacht',
    phase_first_light: 'Erstes Licht',
    phase_dawn: 'Bürgerliche Morgendämmerung',
    phase_sunrise: 'Sonnenaufgang',
    phase_day: 'Tag',
    phase_golden_hour: 'Goldene Stunde',
    phase_sunset: 'Sonnenuntergang',
    phase_blue_hour: 'Blaue Stunde',
    language: 'Sprache',
    lang_zh: 'Chinesisch',
    lang_en: 'Englisch',
    lang_ja: 'Japanisch',
    lang_de: 'Deutsch',
    period_night_name: 'Nacht',
    period_night_desc: 'Schwaches Licht für Sterne & Langzeitbelichtung',
    period_first_light_name: 'Erstes Licht',
    period_first_light_desc: 'Silhouetten & sanfter Kontrast – früh vor Ort sein',
    period_dawn_name: 'Bürgerliche Morgendämmerung',
    period_dawn_desc: 'Schnell wachsende Tonwerte – Aufwärmphase',
    period_sunrise_name: 'Sonnenaufgang',
    period_sunrise_desc: 'Farbtemperatur ändert sich rasant – durchgehend fotografieren',
    period_day_name: 'Tag',
    period_day_desc: 'Hoher Kontrast – Highlights kontrollieren, Schatten nutzen',
    period_golden_hour_name: 'Goldene Stunde',
    period_golden_hour_desc: 'Warm gerichtetes Licht verleiht Tiefe & Struktur',
    period_sunset_name: 'Sonnenuntergang',
    period_sunset_desc: 'Farbverläufe & Nachglühen – Wolken beobachten',
    period_blue_hour_name: 'Blaue Stunde',
    period_blue_hour_desc: 'Kalt / warm Balance – Stadtlichter perfekt eingebettet',
    appInfoTitle: 'App Info',
    appSlogan: 'Für das Licht gemacht',
    appIntro: 'BlueHour ist ein Werkzeug für Fotografen. Es berechnet goldene & blaue Stunde für jeden Ort und jedes Datum.',
    coreFeatures: 'Kernfunktionen',
    feature_preciseAstronomy: '• Präzise Sonnen- & Dämmerungsdaten',
    feature_dynamicPeriods: '• Dynamische Phasenlängen nach Saison & Breite',
    feature_globalSearch: '• Globale Suche mit Verlauf',
    feature_liveTracking: '• Live Phasen-Tracking mit Fortschritt',
    feature_timezone: '• Intelligente Zeitzonenbehandlung',
    feedbackWelcome: 'Ihr Feedback zählt',
    feedbackDesc: 'Wir möchten das beste Planungstool bauen. Ideen willkommen.',
    dataCredits: 'Daten & Danksagung',
    dataCreditsDesc: 'Diese App nutzt folgende Dienste – Danke:',
    credit_sunrise_sunset: '• Sonnendaten: Sunrise-Sunset.org',
    credit_nominatim: '• Geokodierung: Nominatim (OpenStreetMap)',
    versionLabel: 'Version',
    searchCityTitle: 'Stadt / Ort suchen',
    searchPlaceholder: 'Stadtname eingeben (z.B. Beijing, Tokyo, Paris)',
    recentSelections: 'Zuletzt gewählt',
    clear: 'Leeren',
    noResults: 'Keine Ergebnisse',
    searchFailed: 'Suche fehlgeschlagen',
  },
};

// 多语言拍摄建议
const tipsMap: Record<AppLocale, Record<string, string[]>> = {
  zh: {
    'night': ['尝试长曝光拍摄星空', '使用三脚架与快门线', '提高ISO注意降噪'],
    'first-light': ['拍摄山峦剪影', '注意光比，降低曝光', '提前到位取景'],
    'dawn': ['光线柔和，适合风景与人像', '使用偏振镜增强天空层次', '尝试云层慢门'],
    'sunrise': ['抓住光线变化瞬间', '前后各拍几分钟', '逆光剪影构图'],
    'day': ['利用阴影构图', '高快门凝固动作', 'ND镜控制高光'],
    'golden-hour': ['暖色调人像风景', '逆光轮廓光', '侧逆光营造层次'],
    'sunset': ['关注天空层次', '包围曝光保细节', '寻找前景叙事'],
    'blue-hour': ['城市灯光与冷调天空', '小光圈星芒', '白平衡偏冷营造氛围'],
  },
  en: {
    'night': ['Try long exposures for stars', 'Use tripod & remote release', 'Raise ISO but manage noise'],
    'first-light': ['Silhouettes of ridgelines', 'Control contrast / expose low', 'Arrive early to frame'],
    'dawn': ['Soft light for landscape & portrait', 'Use polarizer for sky depth', 'Experiment with cloud motion'],
    'sunrise': ['Capture rapid light changes', 'Shoot a few mins before/after', 'Backlight for silhouettes'],
    'day': ['Use shadows for composition', 'High shutter freeze action', 'ND filter to tame highlights'],
    'golden-hour': ['Warm portraits & landscapes', 'Backlit rim light', 'Side/back light for depth'],
    'sunset': ['Watch gradient in the sky', 'Bracket for dynamic range', 'Add foreground storytelling'],
    'blue-hour': ['City lights + deep blue sky', 'Small aperture starbursts', 'Cool WB for mood'],
  },
  ja: {
    'night': ['星空の長時間露光を試す', '三脚とレリーズを使用', 'ISO上げ過ぎに注意しノイズ管理'],
    'first-light': ['稜線のシルエット', 'コントラストを抑え低めに露出', '早めに到着し構図決定'],
    'dawn': ['柔らかい光で風景/人物に最適', '偏光フィルターで空を強調', '雲の流れをスローで表現'],
    'sunrise': ['光の変化を連続で捉える', '前後数分も撮影価値あり', '逆光でシルエット表現'],
    'day': ['影を活かした構図', '高速シャッターで動きを止める', 'NDでハイライト抑制'],
    'golden-hour': ['暖色で人物と風景を演出', '逆光で縁取り光', 'サイドライトで立体感'],
    'sunset': ['空のグラデーションを観察', 'ブラケットでダイナミックレンジ確保', '前景でストーリー性'],
    'blue-hour': ['都市光と青空のコントラスト', '小絞りで光条', 'WBを寒色寄りに'],
  },
  de: {
    'night': ['Langzeitbelichtung für Sterne', 'Stativ und Fernauslöser nutzen', 'ISO erhöhen – Rauschen kontrollieren'],
    'first-light': ['Bergsilhouetten aufnehmen', 'Kontrast beachten, etwas unterbelichten', 'Früh ankommen für Komposition'],
    'dawn': ['Weiches Licht für Landschaft & Portrait', 'Polfilter für Himmelsstruktur', 'Wolken mit Langzeitbelichtung'],
    'sunrise': ['Schnelle Lichtwechsel einfangen', 'Vor & nach dem Aufgang weiter fotografieren', 'Gegenlicht Silhouetten'],
    'day': ['Schatten als Gestaltung nutzen', 'Hohe Verschlusszeit für Action', 'ND-Filter gegen Überstrahlung'],
    'golden-hour': ['Warme Portraits & Landschaften', 'Gegenlicht-Randlicht', 'Seitenlicht für Tiefe'],
    'sunset': ['Himmelstonwerte beobachten', 'Belichtungsreihen für Details', 'Vordergrund zur Story'],
    'blue-hour': ['Stadtlichter + tiefblauer Himmel', 'Kleine Blende für Sternstrahlen', 'Kühler Weißabgleich für Stimmung'],
  },
};

export function getPhaseLabel(phase: string, t: (k:string)=>string) {
  switch (phase) {
    case 'night': return t('phase_night');
    case 'first-light': return t('phase_first_light');
    case 'dawn': return t('phase_dawn');
    case 'sunrise': return t('phase_sunrise');
    case 'day': return t('phase_day');
    case 'golden-hour': return t('phase_golden_hour');
    case 'sunset': return t('phase_sunset');
    case 'blue-hour': return t('phase_blue_hour');
    default: return phase;
  }
}

export function getPhaseTips(locale: AppLocale, phase: string): string[] {
  return tipsMap[locale][phase] || [];
}

export function detectSystemLocale(): AppLocale {
  const sys = Localization.locale.split('-')[0].toLowerCase();
  if (sys.startsWith('zh')) return 'zh';
  if (sys.startsWith('en')) return 'en';
  if (sys.startsWith('ja')) return 'ja';
  if (sys.startsWith('de')) return 'de';
  return 'en';
}

export const i18n = { resources };

export function useI18n(manual?: AppLocale) {
  const [locale, setLocale] = useState<AppLocale>(manual || detectSystemLocale());
  useEffect(() => {
    AsyncStorage.getItem('app.locale').then(stored => {
      if (stored && ['zh','en','ja','de'].includes(stored)) {
        setLocale(stored as AppLocale);
      }
    }).catch(()=>{});
  }, []);
  const changeLocale = (l: AppLocale) => {
    setLocale(l);
    AsyncStorage.setItem('app.locale', l).catch(()=>{});
  };
  const t = (key: string): string => resources[locale][key] || key;
  return { locale, setLocale: changeLocale, t };
}
